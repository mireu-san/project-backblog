<style>
    .comment { margin-bottom: 10px; }
    .comment .comment { margin-left: 20px; }  /* nested comments move to the right */
</style>

<div class="comment-section">
    <h3>Comments</h3>

    {% for comment in post.comments.all %}
        <div class="comment">
            <p><strong>{{ comment.author }}</strong></p>
            <p>{{ comment.text }}</p>
            {% if user.is_authenticated and user == comment.author %}
                <a href="{% url 'blog:comment_delete' pk=post.pk comment_pk=comment.pk %}">Delete</a>
            {% endif %}

            <!-- 대댓글 표시 -->
            {% for child_comment in comment.children.all %}
                <div class="comment">
                    <p><strong>{{ child_comment.author }}</strong></p>
                    <p>{{ child_comment.text }}</p>
                    {% if user.is_authenticated and user == child_comment.author %}
                        <a href="{% url 'blog:comment_delete' pk=post.pk comment_pk=child_comment.pk %}">Delete</a>
                    {% endif %}
                </div>
            {% endfor %}

            <!-- Reply 버튼 -->
            {% if user.is_authenticated %}
                <button class="reply-button" onclick="showReplyForm({{ comment.id }})">Reply</button>
            {% endif %}

            <!-- 대댓글 작성 폼 (기본적으로 숨김) -->
            <div class="comment-form" id="replyForm{{ comment.id }}" style="display: none;">
                <h4>Leave a Reply</h4>
                <form method="POST" action="{% url 'blog:comment_new' pk=post.pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="parent_comment_id" value="{{ comment.id }}">
                    <label for="text">Comment:</label>
                    <textarea id="text" name="text" required></textarea>
                    <button type="submit">Submit</button>
                </form>
            </div>
        </div>
    {% endfor %}

    <!-- 원본 댓글 작성 폼 -->
    {% if user.is_authenticated %}
        <div class="comment-form">
            <h4>Leave a Comment</h4>
            <form method="POST" action="{% url 'blog:comment_new' pk=post.pk %}">
                {% csrf_token %}
                <label for="text">Comment:</label>
                <textarea id="text" name="text" required></textarea>
                <button type="submit">Submit</button>
            </form>
        </div>
    {% else %}
        <p>You must be logged in to leave a comment.</p>
    {% endif %}
</div>

<script>
function showReplyForm(commentId) {
    const replyForm = document.getElementById(`replyForm${commentId}`);
    replyForm.style.display = 'block';
}
</script>
